@model IEnumerable<ShopQuanAo_MVC.Models.AdminOrderVM>
@{
    ViewBag.Title = "Quản lý Đơn hàng";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="d-flex flex-column gap-4">
    @if (TempData["Message"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Message"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <section id="orders">
        <h4 class="mb-3">Danh sách Đơn hàng</h4>
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table align-middle table-hover mb-0">
                        <thead class="bg-light">
                            <tr class="text-muted">
                                <th class="ps-3">Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th>Thành tiền</th>
                                <th>Thanh toán</th>
                                <th>Trạng thái</th>
                                <th class="text-end pe-3">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                foreach (var item in Model)
                                {
                                    // Tạo ID duy nhất cho mỗi dòng form
                                    string formId = "form_" + item.MaDonHang;

                                    <tr>
                                        <td class="ps-3 fw-bold">@item.MaDonHang</td>
                                        <td>@item.TenKhachHang</td>
                                        <td>@item.NgayDat.ToString("dd/MM/yyyy")</td>

                                        @* Hiển thị Thành Tiền *@
                                        <td class="fw-bold text-danger">@item.TongTien.ToString("N0")đ</td>

                                        @* Cột Thanh Toán *@
                                        <td>
                                            <select name="daThanhToan" form="@formId" class="form-select form-select-sm"
                                                    style="width: 140px; @(item.DaThanhToan ? "background-color:#d1e7dd" : "background-color:#f8d7da")">
                                                <option value="true" @(item.DaThanhToan ? "selected" : "")>Đã thanh toán</option>
                                                <option value="false" @(!item.DaThanhToan ? "selected" : "")>Chưa thanh toán</option>
                                            </select>
                                        </td>

                                        @* Cột Trạng Thái *@
                                        <td>
                                            <select name="trangThai" form="@formId" class="form-select form-select-sm" style="width: 150px;">
                                                @foreach (var st in new[] { "Chờ xác nhận", "Đang giao", "Hoàn tất", "Hủy" })
                                                {
                                                    <option value="@st" @(item.TrangThaiDonHang == st ? "selected" : "")>@st</option>
                                                }
                                            </select>
                                        </td>

                                        @* Cột Hành Động - Chứa Form *@
                                        <td class="text-end pe-3">
                                            <form id="@formId" action="@Url.Action("UpdateOrder", "Dashboard", new { area = "Admin" })" method="post">
                                                <input type="hidden" name="id" value="@item.MaDonHang" />
                                                <button type="submit" class="btn btn-sm btn-primary">
                                                    <i class="fas fa-save"></i> Lưu
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="7" class="text-center py-4">Chưa có đơn hàng nào.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
             $.get('@Url.Action("GetRevenueStats", "Dashboard", new { area = "Admin" })', function (data) {
                $('#revTotal').text(data.TongDoanhThu.toLocaleString('vi-VN') + 'đ');
                $('#revDone').text(data.DonHoanThanh);
                $('#revProcessing').text(data.DonDangXuLy);
                $('#revRateText').text(data.TyLeHoanThanh + '%');
                $('#revRateBar').css('width', data.TyLeHoanThanh + '%');
            });
        });
    </script>
}
